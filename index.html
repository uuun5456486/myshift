<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#f472b6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>ãƒã‚¤ã‚·ãƒ•ãƒˆ - ã‚·ãƒ•ãƒˆç®¡ç†</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #fce7f3 0%, #dbeafe 100%);
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-user-select: none;
      user-select: none;
    }

    .header {
      background: white;
      border-bottom: 4px solid #f472b6;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .app-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #f472b6, #db2777);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 4px 6px rgba(244, 114, 182, 0.3);
    }

    .app-title {
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .app-title:active {
      opacity: 0.7;
    }

    .app-title h1 {
      font-size: 24px;
      color: #1f2937;
      font-weight: 700;
    }

    .app-title p {
      font-size: 12px;
      color: #6b7280;
    }

    .sync-status {
      font-size: 11px;
      color: #10b981;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .sync-dot {
      width: 6px;
      height: 6px;
      background: #10b981;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 16px;
    }

    .tabs {
      display: flex;
      gap: 8px;
      background: white;
      padding: 4px;
      border-radius: 12px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .tab {
      flex: 1;
      padding: 10px;
      border: none;
      background: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab.active {
      background: #f472b6;
      color: white;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .profile-selector {
      background: white;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .profile-selector h3 {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .profile-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
    }

    .profile-btn {
      padding: 12px;
      border: 2px solid #e5e7eb;
      background: white;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .profile-btn.active {
      border-color: #f472b6;
      background: #fce7f3;
      color: #db2777;
    }

    .profile-btn:active {
      transform: scale(0.95);
    }

    .profile-icon {
      font-size: 20px;
    }

    .profile-name {
      font-size: 11px;
    }

    .legend {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      color: #6b7280;
      margin-top: 8px;
      justify-content: center;
    }

    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .my-dot {
      background: #f472b6;
    }

    .partner-dot {
      background: #a855f7;
    }

    .month-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .month-nav button {
      background: none;
      border: none;
      font-size: 24px;
      padding: 8px 16px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .month-title-btn {
      background: none;
      border: none;
      font-size: 18px;
      color: #1f2937;
      font-weight: 700;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 8px;
    }

    .month-title-btn:hover {
      background: #f3f4f6;
    }

    .month-nav button:active {
      background: #fce7f3;
    }



    .shift-stamps {
      margin-bottom: 16px;
    }

    .shift-stamps h3 {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 12px;
      font-weight: 600;
    }

    .stamps-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    .stamp {
      padding: 12px 8px;
      border-radius: 8px;
      text-align: center;
      font-size: 11px;
      font-weight: 700;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: transform 0.2s;
    }

    .stamp:active {
      transform: scale(0.95);
    }

    .stamp.active {
      box-shadow: 0 0 0 3px #f472b6;
      transform: scale(1.05);
    }

    .stamp-day {
      background: #fbbf24;
      color: #78350f;
    }

    .stamp-night {
      background: #4f46e5;
      color: white;
    }

    .stamp-early {
      background: #fb923c;
      color: #7c2d12;
    }

    .stamp-late {
      background: #a855f7;
      color: white;
    }

    .stamp-off {
      background: #4ade80;
      color: #14532d;
    }

    .help-text {
      text-align: center;
      font-size: 12px;
      color: #6b7280;
    }

    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 8px;
    }

    .weekday {
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      padding: 8px 0;
    }

    .weekday:first-child {
      color: #ef4444;
    }

    .weekday:last-child {
      color: #3b82f6;
    }

    .calendar-day.holiday .day-number {
      color: #ef4444;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .calendar-day {
      aspect-ratio: 1;
      border: 2px solid #f3f4f6;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 4px;
    }

    .calendar-day:active {
      transform: scale(0.95);
    }

    .calendar-day.today {
      background: #fce7f3;
    }

    .day-number {
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .day-shift {
      font-size: 9px;
      font-weight: 700;
      padding: 2px 4px;
      border-radius: 4px;
      white-space: nowrap;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      animation: fadeIn 0.2s;
    }

    .modal.show {
      display: flex;
      align-items: flex-end;
      justify-content: center;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }

      to {
        transform: translateY(0);
      }
    }

    .modal-content {
      background: white;
      border-radius: 24px 24px 0 0;
      padding: 24px;
      width: 100%;
      max-width: 600px;
      animation: slideUp 0.3s;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .modal-header h3 {
      font-size: 18px;
      color: #1f2937;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 4px;
      color: #6b7280;
    }

    .shift-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .shift-option {
      padding: 20px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s;
    }

    .shift-option:active {
      transform: scale(0.95);
    }

    .shift-time {
      font-size: 11px;
      opacity: 0.9;
      margin-top: 4px;
    }

    .delete-btn {
      width: 100%;
      padding: 14px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .delete-btn:active {
      background: #dc2626;
    }

    .mode-indicator {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #f472b6, #db2777);
      color: white;
      padding: 12px 24px;
      border-radius: 24px;
      font-size: 14px;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(244, 114, 182, 0.4);
      z-index: 999;
      display: none;
      align-items: center;
      gap: 8px;
      animation: slideDown 0.3s;
    }

    .mode-indicator.show {
      display: flex;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    .mode-cancel {
      background: rgba(255, 255, 255, 0.3);
      border: none;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      margin-left: 8px;
    }

    .setup-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .setup-modal.show {
      display: flex;
    }

    .setup-content {
      background: white;
      border-radius: 20px;
      padding: 24px;
      max-width: 400px;
      width: 100%;
      animation: slideUp 0.3s;
    }

    .setup-content h2 {
      font-size: 20px;
      color: #1f2937;
      margin-bottom: 8px;
      text-align: center;
    }

    .setup-content p {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 20px;
      text-align: center;
    }

    .name-input-group {
      margin-bottom: 16px;
    }

    .name-input-group label {
      display: block;
      font-size: 14px;
      color: #1f2937;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .name-input-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      font-family: inherit;
    }

    .name-input-group input:focus {
      outline: none;
      border-color: #f472b6;
    }

    .setup-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #f472b6, #db2777);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .setup-btn:active {
      transform: scale(0.98);
    }

    .share-section {
      margin-top: 20px;
      padding: 16px;
      background: #f9fafb;
      border-radius: 12px;
    }

    .share-section h4 {
      font-size: 14px;
      color: #1f2937;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .share-code {
      background: white;
      padding: 12px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 18px;
      text-align: center;
      letter-spacing: 2px;
      color: #f472b6;
      font-weight: 700;
      border: 2px dashed #f472b6;
      margin-bottom: 8px;
    }

    .share-hint {
      font-size: 12px;
      color: #6b7280;
      text-align: center;
    }

    .hidden {
      display: none !important;
    }

    .stats-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: #f9fafb;
      border-radius: 8px;
    }

    .stat-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .stat-info h4 {
      font-size: 14px;
      color: #1f2937;
      margin-bottom: 2px;
    }

    .stat-info p {
      font-size: 11px;
      color: #6b7280;
    }

    .stat-count {
      font-size: 24px;
      font-weight: 700;
      color: #1f2937;
    }

    .summary-box {
      margin-top: 16px;
      padding: 16px;
      background: #fce7f3;
      border-radius: 8px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .summary-row:last-child {
      margin-bottom: 0;
    }

    .summary-label {
      color: #6b7280;
    }

    .summary-value {
      font-weight: 700;
      color: #1f2937;
    }

    .password-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #fce7f3 0%, #dbeafe 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      padding: 20px;
    }

    .password-screen.hidden {
      display: none;
    }

    .password-box {
      background: white;
      border-radius: 20px;
      padding: 32px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }

    .password-box h2 {
      font-size: 24px;
      color: #1f2937;
      margin-bottom: 8px;
      text-align: center;
    }

    .password-box p {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 24px;
      text-align: center;
    }

    .password-input {
      width: 100%;
      padding: 14px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 18px;
      text-align: center;
      letter-spacing: 2px;
      font-weight: 600;
      margin-bottom: 16px;
      font-family: inherit;
      text-transform: uppercase;
    }

    .password-input:focus {
      outline: none;
      border-color: #f472b6;
    }

    .password-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #f472b6, #db2777);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .password-btn:active {
      transform: scale(0.98);
    }

    .password-error {
      color: #ef4444;
      font-size: 13px;
      text-align: center;
      margin-top: 8px;
      display: none;
    }

    .password-error.show {
      display: block;
    }

    .lock-icon {
      font-size: 64px;
      text-align: center;
      margin-bottom: 16px;
    }

    .auth-hint {
      font-size: 12px;
      color: #6b7280;
      text-align: center;
      margin-top: 12px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>

<body>
  <div class="password-screen" id="passwordScreen">
    <div class="password-box">
      <div class="lock-icon">ğŸ”—</div>
      <h2>å…±æœ‰ã‚³ãƒ¼ãƒ‰å…¥åŠ›</h2>
      <p>2äººã®å…±æœ‰ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
      <input type="text" class="password-input" id="passwordInput" placeholder="å…±æœ‰ã‚³ãƒ¼ãƒ‰" maxlength="10">
      <button class="password-btn" onclick="checkPassword()">é–‹ã</button>
      <div class="password-error" id="passwordError">å…±æœ‰ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™</div>
      <div class="auth-hint">
        ğŸ’¡ åˆã‚ã¦ã®æ–¹ã¯é©å½“ãªã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã¨æ–°è¦ä½œæˆã•ã‚Œã¾ã™
      </div>
    </div>
  </div>

  <div class="header">
    <div class="header-content">
      <div class="header-left">
        <div class="app-icon">ğŸ“…</div>
        <div class="app-title" onclick="goToToday()">
          <h1>ãƒã‚¤ã‚·ãƒ•ãƒˆ</h1>
          <p>ã‚·ãƒ•ãƒˆç®¡ç†</p>
        </div>
      </div>
      <div class="sync-status" id="syncStatus">
        <div class="sync-dot"></div>
        <span>åŒæœŸä¸­</span>
      </div>
    </div>
  </div>

  <div class="mode-indicator" id="modeIndicator">
    <span id="modeText"></span>
    <button class="mode-cancel" onclick="cancelMode()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>

  <div class="container">
    <div class="tabs">
      <button class="tab active" onclick="switchTab('calendar')">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>
      <button class="tab" onclick="switchTab('shiftSettings')">ã‚·ãƒ•ãƒˆè¨­å®š</button>
      <button class="tab" onclick="switchTab('settings')">ã‚¢ãƒ—ãƒªè¨­å®š</button>
    </div>

    <div id="calendarTab">
      <div class="profile-selector">
        <h3>è¡¨ç¤ºåˆ‡æ›¿</h3>
        <div class="profile-buttons">
          <button class="profile-btn active" onclick="switchProfile('both')" id="btnBoth">
            <div class="profile-icon">ğŸ‘¥</div>
            <div class="profile-name">ä¸¡æ–¹</div>
          </button>
          <button class="profile-btn" onclick="switchProfile('mine')" id="btnMine">
            <div class="profile-icon">ğŸ‘¤</div>
            <div class="profile-name" id="myNameDisplay">è‡ªåˆ†</div>
          </button>
          <button class="profile-btn" onclick="switchProfile('partner')" id="btnPartner">
            <div class="profile-icon">ğŸ’œ</div>
            <div class="profile-name" id="partnerNameDisplay">ç›¸æ‰‹</div>
          </button>
        </div>
        <div class="legend" id="legend">
          <div class="legend-dot my-dot"></div>
          <span id="myNameLegend">è‡ªåˆ†</span>
          <div class="legend-dot partner-dot"></div>
          <span id="partnerNameLegend">ç›¸æ‰‹</span>
        </div>
      </div>

      <div class="card">
        <div class="month-nav">
          <button onclick="changeMonth(-1)">â†</button>
          <div style="display: flex; align-items: center;">
            <button id="monthTitle" class="month-title-btn" onclick="openDatePicker()"></button>
          </div>
          <button onclick="changeMonth(1)">â†’</button>
        </div>
      </div>

      <div class="card">
        <div class="weekdays">
          <div class="weekday">æ—¥</div>
          <div class="weekday">æœˆ</div>
          <div class="weekday">ç«</div>
          <div class="weekday">æ°´</div>
          <div class="weekday">æœ¨</div>
          <div class="weekday">é‡‘</div>
          <div class="weekday">åœŸ</div>
        </div>
        <div class="calendar-grid" id="calendar"></div>
      </div>

      <div class="card shift-stamps">
        <h3>ã‚·ãƒ•ãƒˆã‚¹ã‚¿ãƒ³ãƒ—</h3>
        <div class="stamps-grid" id="stampsGrid">
          <!-- ã“ã“ã«å‹•çš„ã«ç”Ÿæˆ -->
        </div>
        <p class="help-text" id="helpText">ğŸ“… ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é¸ã‚“ã§é€£ç¶šå…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ï¼</p>
      </div>
    </div>

    <div id="shiftSettingsTab" class="hidden">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h3 style="font-size: 16px; color: #1f2937;">ğŸ“ ã‚·ãƒ•ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç·¨é›†</h3>
          <button onclick="openShiftEditModal()"
            style="background: #f472b6; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">ï¼‹
            è¿½åŠ </button>
        </div>
        <div id="shiftPatternList" class="stats-list">
          <!-- JSã§ç”Ÿæˆ -->
        </div>
      </div>
    </div>

    <div id="settingsTab" class="hidden">
      <div class="card">
        <h3 style="font-size: 16px; margin-bottom: 16px; color: #1f2937;">âš™ï¸ è¨­å®š</h3>

        <div style="margin-bottom: 24px; padding: 16px; background: #fce7f3; border-radius: 12px;">
          <h4 style="font-size: 14px; margin-bottom: 12px; color: #1f2937; font-weight: 600;">ğŸ”— å…±æœ‰ã‚³ãƒ¼ãƒ‰</h4>
          <div style="background: white; padding: 16px; border-radius: 8px; text-align: center; margin-bottom: 12px;">
            <div style="font-size: 28px; font-weight: 700; color: #f472b6; letter-spacing: 4px;" id="shareCodeSettings">
              -----</div>
          </div>
          <p style="font-size: 12px; color: #6b7280; text-align: center; margin-bottom: 12px;">ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ç›¸æ‰‹ã«æ•™ãˆã¦ãã ã•ã„</p>

          <div style="border-top: 1px solid #fce7f3; padding-top: 12px; margin-top: 12px;">
            <p style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">ç›¸æ‰‹ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦åŒæœŸ:</p>
            <input type="text" id="joinShareCode" placeholder="ç›¸æ‰‹ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›" maxlength="10"
              style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; text-transform: uppercase; margin-bottom: 8px;">
            <button onclick="joinWithCode()"
              style="width: 100%; padding: 10px; background: #f472b6; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
              ã“ã®ã‚³ãƒ¼ãƒ‰ã§åŒæœŸã™ã‚‹
            </button>
          </div>

          <p style="font-size: 11px; color: #ef4444; text-align: center; margin-top: 8px;">â€»2äººã¨ã‚‚åŒã˜ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã¨åŒæœŸã•ã‚Œã¾ã™</p>
        </div>

        <div style="margin-bottom: 24px; padding: 16px; background: #f9fafb; border-radius: 12px;">
          <h4 style="font-size: 14px; margin-bottom: 12px; color: #1f2937; font-weight: 600;">ğŸ‘¤ åå‰ã®å¤‰æ›´</h4>
          <div style="margin-bottom: 12px;">
            <label style="font-size: 12px; color: #6b7280; display: block; margin-bottom: 4px;">ã‚ãªãŸã®åå‰:</label>
            <input type="text" id="myNameSetting" value=""
              style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
          </div>
          <div style="margin-bottom: 12px;">
            <label style="font-size: 12px; color: #6b7280; display: block; margin-bottom: 4px;">ç›¸æ‰‹ã®åå‰:</label>
            <input type="text" id="partnerNameSetting" value=""
              style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
          </div>
          <button onclick="updateNames()"
            style="width: 100%; padding: 12px; background: linear-gradient(135deg, #f472b6, #db2777); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
            åå‰ã‚’ä¿å­˜
          </button>
        </div>

        <div style="padding: 16px; background: #f9fafb; border-radius: 12px; border: 2px dashed #e5e7eb;">
          <h4 style="font-size: 14px; margin-bottom: 8px; color: #1f2937; font-weight: 600;">â„¹ï¸ ä½¿ã„æ–¹</h4>
          <ul style="font-size: 12px; color: #6b7280; line-height: 1.6; padding-left: 20px;">
            <li>ä¸Šã®å…±æœ‰ã‚³ãƒ¼ãƒ‰ã‚’ç›¸æ‰‹ã«æ•™ãˆã‚‹</li>
            <li>ç›¸æ‰‹ã‚‚åŒã˜ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹</li>
            <li>è‡ªå‹•çš„ã«ã‚·ãƒ•ãƒˆãŒåŒæœŸã•ã‚Œã¾ã™</li>
            <li>ã€ŒğŸ‘¥ä¸¡æ–¹ã€ã‚¿ãƒ–ã§2äººã®ã‚·ãƒ•ãƒˆã‚’ç¢ºèª</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="modal" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 id="modalTitle"></h3>
        <button class="close-btn" onclick="closeModal()">Ã—</button>
      </div>
      <div class="shift-options" id="shiftOptionsContainer">
        <!-- JSã§ç”Ÿæˆ -->
      </div>
      <button class="delete-btn" id="deleteBtn" onclick="deleteShift()">ã‚·ãƒ•ãƒˆã‚’å‰Šé™¤</button>
    </div>
  </div>

  <div class="setup-modal" id="setupModal">
    <div class="setup-content">
      <h2>ğŸ‘‹ åˆæœŸè¨­å®š</h2>
      <p>ã‚ãªãŸã¨ç›¸æ‰‹ã®åå‰ã‚’è¨­å®šã—ã¦ãã ã•ã„</p>

      <div class="name-input-group">
        <label>ã‚ãªãŸã®åå‰</label>
        <input type="text" id="myNameInput" placeholder="ä¾‹: ãŸã‚ã†" maxlength="10">
      </div>

      <div class="name-input-group">
        <label>ç›¸æ‰‹ã®åå‰</label>
        <input type="text" id="partnerNameInput" placeholder="ä¾‹: ã¯ãªã“" maxlength="10">
      </div>

      <div class="name-input-group">
        <label>å…±æœ‰ã‚³ãƒ¼ãƒ‰</label>
        <input type="text" id="shareCodeInput" placeholder="ç›¸æ‰‹ã‹ã‚‰æ•™ã‚ã£ãŸã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›" maxlength="10"
          style="text-transform: uppercase;">
        <p style="font-size: 11px; color: #6b7280; margin-top: 4px;">â€»ç›¸æ‰‹ãŒã„ãªã„å ´åˆã¯ç©ºæ¬„ã§OK</p>
      </div>

      <button class="setup-btn" onclick="saveNames()">ä¿å­˜ã—ã¦é–‹å§‹</button>

      <div class="share-section">
        <h4>ğŸ”— ã‚ãªãŸã®å…±æœ‰ã‚³ãƒ¼ãƒ‰</h4>
        <div class="share-code" id="shareCodeDisplay">-----</div>
        <p class="share-hint">ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ç›¸æ‰‹ã«æ•™ãˆã¦ãã ã•ã„</p>
      </div>
    </div>
  </div>

  </div>
  </div>

  <div class="modal" id="datePickerModal" onclick="closeDatePicker()">
    <div class="modal-content" onclick="event.stopPropagation()" style="text-align: center;">
      <div class="modal-header">
        <h3>å¹´æœˆã‚’é¸æŠ</h3>
        <button class="close-btn" onclick="closeDatePicker()">Ã—</button>
      </div>
      <div style="display: flex; justify-content: center; gap: 16px; margin-bottom: 24px;">
        <select id="yearSelect"
          style="padding: 12px; border-radius: 8px; border: 1px solid #e5e7eb; font-size: 16px;"></select>
        <select id="monthSelect"
          style="padding: 12px; border-radius: 8px; border: 1px solid #e5e7eb; font-size: 16px;"></select>
      </div>
      <button class="setup-btn" onclick="jumpToDate()">ç§»å‹•ã™ã‚‹</button>
    </div>
  </div>

  <div class="modal" id="shiftEditModal">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 id="shiftEditTitle">ã‚·ãƒ•ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ç·¨é›†</h3>
        <button class="close-btn" onclick="closeShiftEditModal()">Ã—</button>
      </div>

      <div class="name-input-group">
        <label>ã‚·ãƒ•ãƒˆå</label>
        <input type="text" id="shiftNameInput" placeholder="ä¾‹: æ—©ç•ªA">
      </div>

      <div class="name-input-group">
        <label>æ™‚é–“</label>
        <input type="text" id="shiftTimeInput" placeholder="ä¾‹: 9:00-18:00">
      </div>

      <div class="name-input-group">
        <label>çµµæ–‡å­—</label>
        <input type="text" id="shiftEmojiInput" placeholder="ä¾‹: â°" maxlength="2">
      </div>

      <div class="name-input-group">
        <label>ã‚«ãƒ©ãƒ¼</label>
        <div style="display: flex; gap: 8px;">
          <div class="color-option"
            style="background: #fbbf24; width: 30px; height: 30px; border-radius: 50%; cursor: pointer;"
            onclick="selectColor('stamp-day')"></div>
          <div class="color-option"
            style="background: #4f46e5; width: 30px; height: 30px; border-radius: 50%; cursor: pointer;"
            onclick="selectColor('stamp-night')"></div>
          <div class="color-option"
            style="background: #fb923c; width: 30px; height: 30px; border-radius: 50%; cursor: pointer;"
            onclick="selectColor('stamp-early')"></div>
          <div class="color-option"
            style="background: #a855f7; width: 30px; height: 30px; border-radius: 50%; cursor: pointer;"
            onclick="selectColor('stamp-late')"></div>
          <div class="color-option"
            style="background: #4ade80; width: 30px; height: 30px; border-radius: 50%; cursor: pointer;"
            onclick="selectColor('stamp-off')"></div>
          <div class="color-option"
            style="background: #f472b6; width: 30px; height: 30px; border-radius: 50%; cursor: pointer;"
            onclick="selectColor('my-dot')"></div>
        </div>
        <input type="hidden" id="shiftClassInput">
      </div>

      <div style="display: flex; gap: 8px; margin-top: 24px;">
        <button class="delete-btn" id="deleteShiftPatternBtn" onclick="deleteShiftPattern()"
          style="background: #ef4444; color: white;">å‰Šé™¤</button>
        <button class="setup-btn" onclick="saveShiftPattern()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBx1FZXfwbV5VKORpR19yiu6MFV09NIV_g",
      authDomain: "myshift-bcc8c.firebaseapp.com",
      databaseURL: "https://myshift-bcc8c-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "myshift-bcc8c",
      storageBucket: "myshift-bcc8c.firebasestorage.app",
      messagingSenderId: "712132708305",
      appId: "1:712132708305:web:ac475fb8652f56835bc2f0"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const defaultShiftTypes = {
      day: { name: 'æ—¥å‹¤', emoji: 'â˜€ï¸', time: '8:30-17:30', class: 'stamp-day' },
      night: { name: 'å¤œå‹¤', emoji: 'ğŸŒ™', time: '20:30-5:30', class: 'stamp-night' },
      early: { name: 'æ—©ç•ª', emoji: 'ğŸŒ…', time: '7:00-15:30', class: 'stamp-early' },
      late: { name: 'é…ç•ª', emoji: 'ğŸ•', time: '11:00-19:30', class: 'stamp-late' },
      off: { name: 'ä¼‘ã¿', emoji: 'â˜•', time: '-', class: 'stamp-off' }
    };

    let shiftTypes = JSON.parse(localStorage.getItem('shiftTypes')) || defaultShiftTypes;

    // ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®æ›´æ–°ï¼šå¤ã„è¨­å®šãŒã‚ã‚Œã°æ–°ã—ã„æ™‚é–“ã«æ›´æ–°ï¼‰
    if (shiftTypes.day.time === '8:30-17:00') {
      shiftTypes.day.time = '8:30-17:30';
    }
    if (shiftTypes.night.time === '16:30-9:00') {
      shiftTypes.night.time = '20:30-5:30';
    }
    localStorage.setItem('shiftTypes', JSON.stringify(shiftTypes));

    // åˆæœŸåŒ–æ™‚ã«ã‚·ãƒ•ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
    function renderShiftOptions() {
      const container = document.getElementById('shiftOptionsContainer');
      container.innerHTML = '';
      Object.entries(shiftTypes).forEach(([type, info]) => {
        const btn = document.createElement('button');
        btn.className = `shift-option ${info.class}`;
        btn.onclick = () => addShift(type);
        btn.innerHTML = `${info.emoji} ${info.name}<br><span class="shift-time">${info.time}</span>`;
        container.appendChild(btn);
      });

      renderShiftSettingsList();
    }

    function renderShiftSettingsList() {
      const list = document.getElementById('shiftPatternList');
      if (!list) return;

      list.innerHTML = '';
      Object.entries(shiftTypes).forEach(([key, info]) => {
        const item = document.createElement('div');
        item.className = 'stat-item';
        item.onclick = () => openShiftEditModal(key);
        item.style.cursor = 'pointer';

        item.innerHTML = `
          <div class="stat-left">
            <div class="stat-icon ${info.class}">${info.emoji}</div>
            <div class="stat-info">
              <h4>${info.name}</h4>
              <p>${info.time}</p>
            </div>
          </div>
          <div style="color: #f472b6;">âœ</div>
        `;
        list.appendChild(item);
      });
    }

    // ã‚·ãƒ•ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
    let editingShiftKey = null;

    window.openShiftEditModal = function (key = null) {
      editingShiftKey = key;
      const modal = document.getElementById('shiftEditModal');
      const deleteBtn = document.getElementById('deleteShiftPatternBtn');
      const defaultShiftKeys = ['day', 'night', 'early', 'late', 'off'];

      if (key) {
        const info = shiftTypes[key];
        document.getElementById('shiftEditTitle').textContent = 'ã‚·ãƒ•ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ç·¨é›†';
        document.getElementById('shiftNameInput').value = info.name;
        document.getElementById('shiftTimeInput').value = info.time;
        document.getElementById('shiftEmojiInput').value = info.emoji;
        document.getElementById('shiftClassInput').value = info.class;
        
        // åŸºæœ¬ã‚·ãƒ•ãƒˆã¯å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
        if (defaultShiftKeys.includes(key)) {
          deleteBtn.style.display = 'none';
        } else {
          deleteBtn.style.display = 'block';
        }
      } else {
        document.getElementById('shiftEditTitle').textContent = 'ã‚·ãƒ•ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³è¿½åŠ ';
        document.getElementById('shiftNameInput').value = '';
        document.getElementById('shiftTimeInput').value = '';
        document.getElementById('shiftEmojiInput').value = '';
        document.getElementById('shiftClassInput').value = 'stamp-day';
        deleteBtn.style.display = 'none';
      }

      modal.classList.add('show');
    };

    window.closeShiftEditModal = function () {
      document.getElementById('shiftEditModal').classList.remove('show');
    };

    window.selectColor = function (className) {
      document.getElementById('shiftClassInput').value = className;
      // è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆé¸æŠä¸­ã®æ ç·šãªã©ï¼‰ã¯ä»Šå›çœç•¥
      alert('ã‚«ãƒ©ãƒ¼ã‚’é¸æŠã—ã¾ã—ãŸ');
    };

    window.saveShiftPattern = function () {
      const name = document.getElementById('shiftNameInput').value.trim();
      const time = document.getElementById('shiftTimeInput').value.trim();
      const emoji = document.getElementById('shiftEmojiInput').value.trim();
      const className = document.getElementById('shiftClassInput').value;

      if (!name || !emoji) {
        alert('åå‰ã¨çµµæ–‡å­—ã¯å¿…é ˆã§ã™');
        return;
      }

      const key = editingShiftKey || 'custom_' + Date.now();

      shiftTypes[key] = {
        name: name,
        emoji: emoji,
        time: time,
        class: className
      };

      localStorage.setItem('shiftTypes', JSON.stringify(shiftTypes));

      // Firebaseã«åŒæœŸ
      database.ref(`settings/${shareCode}/shiftTypes`).set(shiftTypes);

      renderShiftOptions();
      closeShiftEditModal();
      renderCalendar(); // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å†æç”»ï¼ˆå¤‰æ›´åæ˜ ã®ãŸã‚ï¼‰
    };

    window.deleteShiftPattern = function () {
      if (!editingShiftKey) return;
      
      // åŸºæœ¬ã‚·ãƒ•ãƒˆã¯å‰Šé™¤ä¸å¯
      const defaultShiftKeys = ['day', 'night', 'early', 'late', 'off'];
      if (defaultShiftKeys.includes(editingShiftKey)) {
        alert('åŸºæœ¬ã‚·ãƒ•ãƒˆã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚\nã‚«ã‚¹ã‚¿ãƒ ã‚·ãƒ•ãƒˆã®ã¿å‰Šé™¤å¯èƒ½ã§ã™ã€‚');
        return;
      }
      
      if (confirm('ã“ã®ã‚·ãƒ•ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        delete shiftTypes[editingShiftKey];
        localStorage.setItem('shiftTypes', JSON.stringify(shiftTypes));
        
        // Firebaseã«åŒæœŸ
        database.ref(`settings/${shareCode}/shiftTypes`).set(shiftTypes);
        
        renderShiftOptions();
        closeShiftEditModal();
        renderCalendar();
      }
    };

    // åˆæœŸåŒ–æ™‚ã«ã‚·ãƒ•ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
    function renderShiftOptions() {
      const container = document.getElementById('shiftOptionsContainer');
      container.innerHTML = '';
      Object.entries(shiftTypes).forEach(([type, info]) => {
        const btn = document.createElement('button');
        btn.className = `shift-option ${info.class}`;
        btn.onclick = () => addShift(type);
        btn.innerHTML = `${info.emoji} ${info.name}<br><span class="shift-time">${info.time}</span>`;
        container.appendChild(btn);
      });
      
      // ã‚¹ã‚¿ãƒ³ãƒ—ã‚‚æ›´æ–°
      renderStamps();
    }

    function renderStamps() {
      const stampsGrid = document.getElementById('stampsGrid');
      if (!stampsGrid) return;
      
      stampsGrid.innerHTML = '';
      Object.entries(shiftTypes).forEach(([type, info]) => {
        const stamp = document.createElement('div');
        stamp.className = `stamp ${info.class}`;
        stamp.onclick = () => selectMode(type);
        stamp.innerHTML = `${info.emoji}<br>${info.name}`;
        stampsGrid.appendChild(stamp);
      });
    }

    // ç¥æ—¥ãƒ­ã‚¸ãƒƒã‚¯
    function getHoliday(date) {
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const weekDay = date.getDay(); // 0:Sun, 1:Mon...

      // å›ºå®šç¥æ—¥
      const fixedHolidays = {
        '1-1': 'å…ƒæ—¥',
        '2-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
        '2-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
        '4-29': 'æ˜­å’Œã®æ—¥',
        '5-3': 'æ†²æ³•è¨˜å¿µæ—¥',
        '5-4': 'ã¿ã©ã‚Šã®æ—¥',
        '5-5': 'ã“ã©ã‚‚ã®æ—¥',
        '8-11': 'å±±ã®æ—¥',
        '11-3': 'æ–‡åŒ–ã®æ—¥',
        '11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥'
      };

      let holidayName = fixedHolidays[`${month}-${day}`];

      // ãƒãƒƒãƒ”ãƒ¼ãƒãƒ³ãƒ‡ãƒ¼
      // æˆäººã®æ—¥: 1æœˆã®ç¬¬2æœˆæ›œæ—¥
      if (month === 1 && weekDay === 1 && day >= 8 && day <= 14) holidayName = 'æˆäººã®æ—¥';
      // æµ·ã®æ—¥: 7æœˆã®ç¬¬3æœˆæ›œæ—¥
      if (month === 7 && weekDay === 1 && day >= 15 && day <= 21) holidayName = 'æµ·ã®æ—¥';
      // æ•¬è€ã®æ—¥: 9æœˆã®ç¬¬3æœˆæ›œæ—¥
      if (month === 9 && weekDay === 1 && day >= 15 && day <= 21) holidayName = 'æ•¬è€ã®æ—¥';
      // ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥: 10æœˆã®ç¬¬2æœˆæ›œæ—¥
      if (month === 10 && weekDay === 1 && day >= 8 && day <= 14) holidayName = 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥';

      // æ˜¥åˆ†ãƒ»ç§‹åˆ†ï¼ˆç°¡æ˜“è¨ˆç®—: 2024-2030å¹´é ƒã¾ã§æœ‰åŠ¹ï¼‰
      if (month === 3 && day === Math.floor(20.8431 + 0.242194 * (year - 1980) - Math.floor((year - 1980) / 4))) holidayName = 'æ˜¥åˆ†ã®æ—¥';
      if (month === 9 && day === Math.floor(23.2488 + 0.242194 * (year - 1980) - Math.floor((year - 1980) / 4))) holidayName = 'ç§‹åˆ†ã®æ—¥';

      // æŒ¯æ›¿ä¼‘æ—¥åˆ¤å®šï¼ˆå‰æ—¥ãŒç¥æ—¥ã‹ã¤æ—¥æ›œæ—¥ï¼‰
      if (!holidayName) {
        const yesterday = new Date(date);
        yesterday.setDate(date.getDate() - 1);
        const yHoliday = getHoliday(yesterday);
        if (yHoliday && yesterday.getDay() === 0) {
          return 'æŒ¯æ›¿ä¼‘æ—¥';
        }
      }

      return holidayName;
    }

    let currentDate = new Date();
    let myShifts = {};
    let partnerShifts = {};
    let selectedDate = null;
    let continuousMode = null;
    let currentProfile = 'both';
    let myName = localStorage.getItem('myName') || '';
    let partnerName = localStorage.getItem('partnerName') || '';
    let shareCode = localStorage.getItem('shareCode') || generateShareCode();
    let myUserId = localStorage.getItem('myUserId') || generateUserId();
    let isAuthenticated = localStorage.getItem('authenticatedCode') === shareCode;

    // å…±æœ‰ã‚³ãƒ¼ãƒ‰èªè¨¼ãƒã‚§ãƒƒã‚¯
    if (!isAuthenticated) {
      document.getElementById('passwordScreen').classList.remove('hidden');
    } else {
      document.getElementById('passwordScreen').classList.add('hidden');
    }

    window.checkPassword = function () {
      const input = document.getElementById('passwordInput').value.trim().toUpperCase();

      if (!input) {
        document.getElementById('passwordError').textContent = 'å…±æœ‰ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        document.getElementById('passwordError').classList.add('show');
        return;
      }

      // å…¥åŠ›ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’å…±æœ‰ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦ä½¿ç”¨
      shareCode = input;
      localStorage.setItem('shareCode', shareCode);
      localStorage.setItem('authenticatedCode', shareCode);

      sessionStorage.setItem('isAuthenticated', 'true');
      document.getElementById('passwordScreen').classList.add('hidden');
      document.getElementById('passwordError').classList.remove('show');

      // Firebaseãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
      setupFirebaseListeners();
      renderCalendar();

      // åˆå›è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      if (!myName || !partnerName) {
        document.getElementById('setupModal').classList.add('show');
        document.getElementById('shareCodeDisplay').textContent = shareCode;
      }
    };

    // Enterã‚­ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³
    document.addEventListener('DOMContentLoaded', function () {
      const passwordInput = document.getElementById('passwordInput');
      if (passwordInput) {
        passwordInput.addEventListener('keypress', function (e) {
          if (e.key === 'Enter') {
            checkPassword();
          }
        });
      }
    });

    function generateShareCode() {
      const code = Math.random().toString(36).substring(2, 8).toUpperCase();
      localStorage.setItem('shareCode', code);
      return code;
    }

    function generateUserId() {
      const id = 'user_' + Math.random().toString(36).substring(2, 11);
      localStorage.setItem('myUserId', id);
      return id;
    }

    // Firebase ãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupFirebaseListeners() {
      // è‡ªåˆ†ã®ã‚·ãƒ•ãƒˆã‚’ç›£è¦–
      const myShiftsRef = database.ref(`shifts/${shareCode}/${myUserId}`);
      myShiftsRef.on('value', (snapshot) => {
        const data = snapshot.val();
        myShifts = data || {};
        renderCalendar();
        updateSyncStatus('åŒæœŸå®Œäº†');
      });

      // ç›¸æ‰‹ã®ã‚·ãƒ•ãƒˆã‚’ç›£è¦–ï¼ˆå…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰è‡ªåˆ†ä»¥å¤–ã‚’å–å¾—ï¼‰
      const allShiftsRef = database.ref(`shifts/${shareCode}`);
      allShiftsRef.on('value', (snapshot) => {
        const allData = snapshot.val() || {};
        partnerShifts = {};

        Object.entries(allData).forEach(([userId, shifts]) => {
          if (userId !== myUserId) {
            Object.assign(partnerShifts, shifts);
          }
        });

        renderCalendar();
      });

      // åå‰ã‚’ç›£è¦–
      const namesRef = database.ref(`names/${shareCode}`);
      namesRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          if (data[myUserId]) {
            myName = data[myUserId];
            localStorage.setItem('myName', myName);
          }

          // ç›¸æ‰‹ã®åå‰ã‚’å–å¾—
          Object.entries(data).forEach(([userId, name]) => {
            if (userId !== myUserId) {
              partnerName = name;
              localStorage.setItem('partnerName', partnerName);
            }
          });

          updateNameDisplays();
        }
      });

      // ã‚·ãƒ•ãƒˆè¨­å®šã‚’ç›£è¦–
      const shiftTypesRef = database.ref(`settings/${shareCode}/shiftTypes`);
      shiftTypesRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          shiftTypes = data;
          localStorage.setItem('shiftTypes', JSON.stringify(shiftTypes));
          renderShiftOptions(); // ã‚¹ã‚¿ãƒ³ãƒ—ã¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’æ›´æ–°
          renderCalendar(); // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚‚æ›´æ–°
        }
      });
    }

    function updateSyncStatus(status) {
      const syncStatus = document.getElementById('syncStatus');
      syncStatus.innerHTML = `<div class="sync-dot"></div><span>${status}</span>`;
    }

    function saveToFirebase(dateKey, shiftType) {
      const shiftRef = database.ref(`shifts/${shareCode}/${myUserId}/${dateKey}`);
      if (shiftType) {
        shiftRef.set(shiftType);
      } else {
        shiftRef.remove();
      }
      updateSyncStatus('ä¿å­˜ä¸­...');
    }

    function saveNamesToFirebase() {
      const nameRef = database.ref(`names/${shareCode}/${myUserId}`);
      nameRef.set(myName);
    }

    window.saveNames = function () {
      myName = document.getElementById('myNameInput').value.trim() || 'è‡ªåˆ†';
      partnerName = document.getElementById('partnerNameInput').value.trim() || 'ç›¸æ‰‹';

      // å…±æœ‰ã‚³ãƒ¼ãƒ‰ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚Œã°ãã‚Œã‚’ä½¿ã†
      const inputShareCode = document.getElementById('shareCodeInput').value.trim().toUpperCase();
      if (inputShareCode) {
        shareCode = inputShareCode;
        localStorage.setItem('shareCode', shareCode);
        console.log('å…¥åŠ›ã•ã‚ŒãŸå…±æœ‰ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨:', shareCode);
      }

      localStorage.setItem('myName', myName);
      localStorage.setItem('partnerName', partnerName);

      saveNamesToFirebase();
      updateNameDisplays();
      document.getElementById('setupModal').classList.remove('show');

      // Firebaseãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®š
      setupFirebaseListeners();
    };

    window.updateNameDisplays = function () {
      document.getElementById('myNameDisplay').textContent = myName;
      document.getElementById('partnerNameDisplay').textContent = partnerName;
      document.getElementById('myNameLegend').textContent = myName;
      document.getElementById('partnerNameLegend').textContent = partnerName;
    };

    window.switchProfile = function (profile) {
      currentProfile = profile;

      document.querySelectorAll('.profile-btn').forEach(btn => btn.classList.remove('active'));
      if (profile === 'mine') {
        document.getElementById('btnMine').classList.add('active');
        document.getElementById('legend').style.display = 'none';
      } else if (profile === 'partner') {
        document.getElementById('btnPartner').classList.add('active');
        document.getElementById('legend').style.display = 'none';
      } else {
        document.getElementById('btnBoth').classList.add('active');
        document.getElementById('legend').style.display = 'flex';
      }

      renderCalendar();

    };

    function getDateKey(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    window.changeMonth = function (offset) {
      currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + offset, 1);
      renderCalendar();

    };

    window.selectMode = function (shiftType) {
      if (currentProfile === 'partner') {
        // ç›¸æ‰‹ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºä¸­ã¯ä½•ã‚‚ã—ãªã„ï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆã‚‚å‡ºã•ãªã„ï¼‰
        return;
      }

      if (continuousMode === shiftType) {
        cancelMode();
      } else {
        continuousMode = shiftType;
        const modeIndicator = document.getElementById('modeIndicator');
        const modeText = document.getElementById('modeText');
        const shiftInfo = shiftTypes[shiftType];

        if (shiftInfo) {
          modeText.textContent = `${shiftInfo.emoji} ${shiftInfo.name}ã‚’é€£ç¶šå…¥åŠ›ä¸­`;
          modeIndicator.classList.add('show');

          document.querySelectorAll('.shift-option').forEach(s => s.classList.remove('active'));
          // è¦‹ãŸç›®ä¸Šã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ï¼ˆå‹•çš„ç”Ÿæˆãªã®ã§ã‚¯ãƒ©ã‚¹ä»˜ä¸ãŒå¿…è¦ã‹ã‚‚ã ãŒã€ä»Šå›ã¯ç°¡æ˜“åŒ–ï¼‰

          document.getElementById('helpText').textContent = 'ğŸ“… æ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—ã—ã¦å…¥åŠ›ï¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§çµ‚äº†';
        }
      }
    };

    window.cancelMode = function () {
      continuousMode = null;
      document.getElementById('modeIndicator').classList.remove('show');
      document.querySelectorAll('.shift-option').forEach(s => s.classList.remove('active'));
      document.getElementById('helpText').textContent = 'ğŸ“… ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é¸ã‚“ã§é€£ç¶šå…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ï¼';
    };

    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();

      document.getElementById('monthTitle').textContent = `${year}å¹´ ${month + 1}æœˆ`;

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay();

      const calendar = document.getElementById('calendar');
      calendar.innerHTML = '';

      for (let i = 0; i < startingDayOfWeek; i++) {
        calendar.innerHTML += '<div></div>';
      }

      const today = new Date();
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateKey = getDateKey(date);
        const myShift = myShifts[dateKey];
        const partnerShift = partnerShifts[dateKey];
        const isToday = date.toDateString() === today.toDateString();
        const holidayName = getHoliday(date);

        let dayClass = 'calendar-day';
        if (isToday) dayClass += ' today';
        if (holidayName) dayClass += ' holiday';

        let shiftHtml = '';

        if (currentProfile === 'mine' && myShift) {
          const shiftInfo = shiftTypes[myShift];
          if (shiftInfo) {
            shiftHtml = `<div class="day-shift ${shiftInfo.class}">${shiftInfo.name}</div>`;
          }
        } else if (currentProfile === 'partner' && partnerShift) {
          const shiftInfo = shiftTypes[partnerShift];
          if (shiftInfo) {
            shiftHtml = `<div class="day-shift ${shiftInfo.class}" style="opacity: 0.8;">${shiftInfo.name}</div>`;
          }
        } else if (currentProfile === 'both') {
          if (myShift && partnerShift) {
            const myInfo = shiftTypes[myShift];
            const partnerInfo = shiftTypes[partnerShift];
            if (myInfo && partnerInfo) {
              shiftHtml = `
                <div style="display: flex; flex-direction: column; gap: 2px; width: 100%;">
                  <div class="day-shift ${myInfo.class}" style="font-size: 8px; padding: 1px 2px;">${myInfo.name}</div>
                  <div class="day-shift ${partnerInfo.class}" style="font-size: 8px; padding: 1px 2px; opacity: 0.8;">${partnerInfo.name}</div>
                </div>
              `;
            }
          } else if (myShift) {
            const shiftInfo = shiftTypes[myShift];
            if (shiftInfo) {
              shiftHtml = `<div class="day-shift ${shiftInfo.class}">${shiftInfo.name}</div>`;
            }
          } else if (partnerShift) {
            const shiftInfo = shiftTypes[partnerShift];
            if (shiftInfo) {
              shiftHtml = `<div class="day-shift ${shiftInfo.class}" style="opacity: 0.8;">${shiftInfo.name}</div>`;
            }
          }
        }

        calendar.innerHTML += `
          <div class="${dayClass}" onclick="handleDateClick('${dateKey}')">
            <div class="day-number">${day}</div>
            ${shiftHtml}
          </div>
        `;
      }
    }

    window.handleDateClick = function (dateKey) {
      if (currentProfile === 'partner') {
        // ç›¸æ‰‹ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºä¸­ã¯ä½•ã‚‚ã—ãªã„
        return;
      }

      if (continuousMode) {
        myShifts[dateKey] = continuousMode;
        saveToFirebase(dateKey, continuousMode);
        renderCalendar();

      } else {
        selectDate(dateKey);
      }
    };

    function selectDate(dateKey) {
      selectedDate = dateKey;
      const [year, month, day] = dateKey.split('-');
      document.getElementById('modalTitle').textContent = `${parseInt(month)}æœˆ${parseInt(day)}æ—¥ã®ã‚·ãƒ•ãƒˆ`;

      const deleteBtn = document.getElementById('deleteBtn');
      if (myShifts[dateKey]) {
        deleteBtn.style.display = 'block';
      } else {
        deleteBtn.style.display = 'none';
      }

      document.getElementById('modal').classList.add('show');
    }

    window.closeModal = function () {
      document.getElementById('modal').classList.remove('show');
    };

    window.addShift = function (shiftType) {
      if (selectedDate) {
        myShifts[selectedDate] = shiftType;
        saveToFirebase(selectedDate, shiftType);
        renderCalendar();

        closeModal();
      }
    };

    window.deleteShift = function () {
      if (selectedDate) {
        delete myShifts[selectedDate];
        saveToFirebase(selectedDate, null);
        renderCalendar();

        closeModal();
      }
    };

    window.switchTab = function (tab) {
      cancelMode();

      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');

      document.getElementById('calendarTab').classList.add('hidden');
      document.getElementById('shiftSettingsTab').classList.add('hidden');
      document.getElementById('settingsTab').classList.add('hidden');

      if (tab === 'calendar') {
        document.getElementById('calendarTab').classList.remove('hidden');
      } else if (tab === 'shiftSettings') {
        document.getElementById('shiftSettingsTab').classList.remove('hidden');
        renderShiftSettingsList();
      } else if (tab === 'settings') {
        document.getElementById('settingsTab').classList.remove('hidden');
        showSettings();
      }
    };

    function showSettings() {
      document.getElementById('shareCodeSettings').textContent = shareCode;
      document.getElementById('myNameSetting').value = myName;
      document.getElementById('partnerNameSetting').value = partnerName;
    }

    window.updateNames = function () {
      const newMyName = document.getElementById('myNameSetting').value.trim();
      const newPartnerName = document.getElementById('partnerNameSetting').value.trim();

      if (newMyName) {
        myName = newMyName;
        localStorage.setItem('myName', myName);
        saveNamesToFirebase();
      }

      if (newPartnerName) {
        partnerName = newPartnerName;
        localStorage.setItem('partnerName', partnerName);
      }

      updateNameDisplays();
      alert('åå‰ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
    };

    window.joinWithCode = function () {
      const inputCode = document.getElementById('joinShareCode').value.trim().toUpperCase();

      if (!inputCode) {
        alert('å…±æœ‰ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      if (inputCode === shareCode) {
        alert('æ—¢ã«ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ä¸­ã§ã™');
        return;
      }

      if (confirm(`å…±æœ‰ã‚³ãƒ¼ãƒ‰ã€Œ${inputCode}ã€ã§åŒæœŸã—ã¾ã™ã‹ï¼Ÿ\n\nâ€»ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ã€Œ${shareCode}ã€ã«æ®‹ã‚Šã¾ã™`)) {
        shareCode = inputCode;
        localStorage.setItem('shareCode', shareCode);

        // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
        myShifts = {};
        partnerShifts = {};

        alert('å…±æœ‰ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸï¼\nãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚');
        location.reload();
      }
    };



    // Today Button
    window.goToToday = function () {
      currentDate = new Date();
      renderCalendar();
    };

    // Date Picker Logic
    window.openDatePicker = function () {
      const modal = document.getElementById('datePickerModal');
      const yearSelect = document.getElementById('yearSelect');
      const monthSelect = document.getElementById('monthSelect');
      const currentYear = currentDate.getFullYear();
      const currentMonth = currentDate.getMonth() + 1;

      // Reset
      yearSelect.innerHTML = '';
      monthSelect.innerHTML = '';

      // Years: current +/- 5 years
      for (let i = currentYear - 5; i <= currentYear + 5; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i + 'å¹´';
        if (i === currentYear) option.selected = true;
        yearSelect.appendChild(option);
      }

      // Months
      for (let i = 1; i <= 12; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i + 'æœˆ';
        if (i === currentMonth) option.selected = true;
        monthSelect.appendChild(option);
      }

      modal.classList.add('show');
    };

    window.closeDatePicker = function () {
      document.getElementById('datePickerModal').classList.remove('show');
    };

    window.jumpToDate = function () {
      const year = parseInt(document.getElementById('yearSelect').value);
      const month = parseInt(document.getElementById('monthSelect').value);
      currentDate = new Date(year, month - 1, 1);
      renderCalendar();
      closeDatePicker();
    };

    // Swipe Logic
    let touchStartX = 0;
    let touchEndX = 0;

    const calendarElement = document.getElementById('calendar');

    calendarElement.addEventListener('touchstart', e => {
      touchStartX = e.changedTouches[0].screenX;
    }, { passive: true });

    calendarElement.addEventListener('touchend', e => {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipe();
    }, { passive: true });

    function handleSwipe() {
      const threshold = 50; // min swipe distance
      const swipeDistance = touchEndX - touchStartX;

      if (Math.abs(swipeDistance) > threshold) {
        if (swipeDistance > 0) {
          // Right swipe -> Prev month
          changeMonth(-1);
        } else {
          // Left swipe -> Next month
          changeMonth(1);
        }
      }
    }

    // åˆæœŸåŒ–
    if (!myName || !partnerName) {
      document.getElementById('setupModal').classList.add('show');
      document.getElementById('shareCodeDisplay').textContent = shareCode;
    }

    updateNameDisplays();
    renderStamps(); // ã‚¹ã‚¿ãƒ³ãƒ—ã‚’åˆæœŸè¡¨ç¤º
    setupFirebaseListeners();
    renderCalendar();

  </script>
</body>

</html>
